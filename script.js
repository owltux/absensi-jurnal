// LANGKAH 5: GANTI URL DI BAWAH INI
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxzdt7494I3nRsPj3bS_JFJWQdzwBFluFnwl-4RloWVOvJ_8DjENpiS4mNSH_U2jyEh/exec";

const kelasSelect=document.getElementById("pilihKelas"),siswaContainer=document.getElementById("daftarSiswaContainer"),loading=document.getElementById("loading"),form=document.getElementById("presensiForm"),submitBtn=document.getElementById("submitBtn"),pesanStatus=document.getElementById("pesanStatus"),quickActionsDiv=document.getElementById("quickActions"),btnPilihSemuaHadir=document.getElementById("pilihSemuaHadir"),jurnalSection=document.getElementById("jurnalSection");async function ambilDaftarKelas(){try{const e=await fetch(`${SCRIPT_URL}?action=getKelas`),t=await e.json();"sukses"===t.status?(kelasSelect.innerHTML='<option value="">-- Pilih Kelas --</option>',t.data.forEach(e=>{e&&kelasSelect.add(new Option(e,e))})):kelasSelect.innerHTML='<option value="">Gagal memuat</option>'}catch(e){console.error("Error fetching kelas:",e),kelasSelect.innerHTML='<option value="">Error</option>'}}async function ambilDaftarSiswa(e){if(e){loading.textContent=`Memuat daftar siswa untuk ${e}...`,loading.style.display="block",siswaContainer.innerHTML="",submitBtn.style.display="none",quickActionsDiv.style.display="none",jurnalSection.style.display="none";try{const t=await fetch(`${SCRIPT_URL}?action=getSiswa&kelas=${encodeURIComponent(e)}`),a=await t.json();if("sukses"===a.status){if(loading.style.display="none",tampilkanSiswa(a.data),a.data.length>0)submitBtn.style.display="block",quickActionsDiv.style.display="flex",jurnalSection.style.display="block";else loading.textContent=`Tidak ada siswa di kelas ${e}.`,loading.style.display="block"}else loading.textContent="Gagal memuat data siswa."}catch(e){console.error("Error fetching siswa:",e),loading.textContent="Terjadi kesalahan jaringan."}}else siswaContainer.innerHTML="",loading.textContent="Pilih kelas untuk menampilkan daftar siswa.",loading.style.display="block",submitBtn.style.display="none",quickActionsDiv.style.display="none",jurnalSection.style.display="none"}function tampilkanSiswa(e){e.forEach((e,t)=>{const a=document.createElement("div");a.classList.add("siswa-row"),a.innerHTML=`\n            <div class="siswa-info">\n                <div class="nama">${t+1}. ${e.nama}</div>\n                <div class="nis">NIS: ${e.nis}</div>\n            </div>\n            <div class="status-pilihan" data-nis="${e.nis}" data-nama="${e.nama}">\n                <label><input type="radio" name="status_${t}" value="Hadir" required> Hadir</label>\n                <label><input type="radio" name="status_${t}" value="Sakit"> Sakit</label>\n                <label><input type="radio" name="status_${t}" value="Izin"> Izin</label>\n                <label><input type="radio" name="status_${t}" value="Alfa"> Alfa</label>\n            </div>\n        `,siswaContainer.appendChild(a)})}form.addEventListener("submit",async function(e){e.preventDefault(),submitBtn.disabled=!0,submitBtn.textContent="Mengirim...",pesanStatus.textContent="";const t=[];document.querySelectorAll(".status-pilihan").forEach((e,a)=>{t.push({nis:e.dataset.nis,nama:e.dataset.nama,status:document.querySelector(`input[name="status_${a}"]:checked`).value})});const a={tanggal:document.getElementById("tanggal").value,kelas:kelasSelect.value,refleksi:document.getElementById("refleksi").value,rencana:document.getElementById("rencana").value,presensi:t};try{await fetch(SCRIPT_URL,{method:"POST",mode:"no-cors",body:JSON.stringify(a)}),pesanStatus.textContent="✓ Absensi & Jurnal berhasil dikirim!",pesanStatus.style.color="green",document.getElementById("refleksi").value="",document.getElementById("rencana").value=""}catch(e){pesanStatus.textContent="❌ Terjadi kesalahan!",pesanStatus.style.color="red"}finally{submitBtn.disabled=!1,submitBtn.textContent="Kirim Absensi & Jurnal"}}),document.addEventListener("DOMContentLoaded",()=>{document.getElementById("tanggal").valueAsDate=new Date,ambilDaftarKelas()}),kelasSelect.addEventListener("change",()=>{ambilDaftarSiswa(kelasSelect.value)}),btnPilihSemuaHadir.addEventListener("click",()=>{document.querySelectorAll('input[type="radio"][value="Hadir"]').forEach(e=>{e.checked=!0})});